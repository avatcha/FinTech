<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Retirement Calculator</title>

  <!-- Font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <style>
    body {
      font-family: 'Inter', sans-serif;
      background: #f7f9fc;
      margin: 0;
      padding-top: 70px; /* space for sticky header */
      color: #0a0f2c;
    }

    .cb-wrap { max-width: 1200px; margin: 0 auto; padding: 0 28px; }
    .cb-header { margin-bottom: 20px; }
    .cb-title { font-size: 40px; font-weight: 700; margin: 0; }
    .cb-sub { font-size: 17px; color: #4a5568; margin-top: 6px; }

    .cb-stack { display: flex; flex-direction: column; gap: 16px; }
    .cb-card {
      background: white; padding: 24px; border-radius: 18px;
      box-shadow: 0 10px 30px rgba(2,6,23,0.07); border: 1px solid #e5e9f2;
    }

    .cb-row { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; }
    @media (min-width:1100px){ .cb-row { grid-template-columns: repeat(3, 1fr); } }

    .cb-field { display: flex; flex-direction: column; gap: 6px; }
    label { font-size: 14px; font-weight: 500; }

    input[type="date"], input[type="number"], select {
      font-size: 18px; padding: 12px 14px; border-radius: 14px;
      border: 1px solid #e5e9f2; background: #fdfdfd;
    }
    input:focus, select:focus {
      border-color: #b8cdfd;
      outline: none;
      box-shadow: 0 0 0 4px rgba(0,82,255,0.12);
    }

    #runCalc, .btn-primary {
      background: #1a73e8; color: white; border: none;
      font-size: 16px; padding: 14px 20px;
      border-radius: 14px; font-weight: 600;
      cursor: pointer; transition: 0.15s;
    }
    #runCalc:hover, .btn-primary:hover { background: #0f5ad2; }

    /* Sticky Header */
    .site-header {
      position: fixed; top: 0; left: 0; right: 0; z-index: 1000;
      background: rgba(255,255,255,0.85);
      backdrop-filter: blur(8px);
      border-bottom: 1px solid #e5e9f2;
    }
    .header-inner { display: flex; justify-content: space-between; align-items: center; min-height: 60px; }
    .brand { font-weight: 700; font-size: 20px; text-decoration: none; color:#0a0f2c; }
    .nav-links { display: flex; gap: 20px; }
    .nav-links a { color:#1a1f33; font-weight: 500; text-decoration:none; }
    .nav-links a:hover { text-decoration: underline; }
    .nav-toggle { display:none; font-size:26px; background:none; border:0; cursor:pointer; }

    @media (max-width:820px){
      .nav-toggle { display:block; }
      .nav-links {
        display:none; position:absolute; right:28px; top:60px;
        background:#fff; padding:12px;
        border:1px solid #e5e9f2; border-radius:12px;
        box-shadow:0 8px 24px rgba(2,6,23,0.15);
      }
      .nav-links.open { display:block; }
      .nav-links a { display:block; padding:8px 10px; }
    }

    /* Tooltip (used in top inputs only) */
    .tooltip-click-container { position:relative; display:inline-flex; align-items:center; gap:8px; }
    .click-icon {
      width:18px; height:18px; border-radius:50%;
      background:#1a73e8; color:white; font-size:12px;
      display:flex; align-items:center; justify-content:center;
      cursor:pointer;
    }
    .tooltip-click-box {
      display:none; position:absolute; top:26px; left:0;
      background:white; padding:14px 16px;
      border-radius:12px; max-width:320px;
      border:1px solid #e5e9f2;
      box-shadow:0 8px 24px rgba(2,6,23,0.15);
      font-size:13px; z-index:9999;
      white-space: normal; overflow-wrap: anywhere;
    }

    /* Toggles (hidden by default) */
    #postCalcOptions {
      display:none; background:#f1f4f9 !important;
      border:1px solid #d7dce5 !important;
      padding:16px !important; border-radius:12px !important;
    }
    .toggle-row {
      display:flex; justify-content:space-between; gap:24px;
      align-items:flex-start; flex-wrap:wrap;
    }
    .toggle-item {
      display:flex; align-items:flex-start; gap:12px;
      white-space: normal; max-width: 100%;
    }
    .toggle-item .tooltip-click-container { align-items:flex-start; }

    .switch { position:relative; width:46px; height:24px; flex:0 0 auto; }
    .switch input { display:none; }
    .slider {
      position:absolute; top:0; left:0; right:0; bottom:0;
      background:#cbd5e1; border-radius:24px; transition:0.2s; cursor:pointer;
    }
    .slider:before {
      content:""; position:absolute;
      width:18px; height:18px; left:3px; bottom:3px;
      background:white; border-radius:50%; transition:0.2s;
    }
    input:checked + .slider { background:#1a73e8; }
    input:checked + .slider:before { transform:translateX(22px); }

    /* Chart title/subtitle center */
    #chartTitle, #chartSubtitle { text-align: center; }

    /* Chart + right prompt */
    .graph-row {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 20px;
      align-items: start;
    }
    #scenarioPrompt {
      display: none;
      border: 1px solid #e5e9f2;
      border-radius: 14px;
      padding: 16px;
      background: #f7f9ff;
    }
    #scenarioPrompt p { margin: 0 0 12px 0; line-height: 1.35; }
    @media (max-width: 900px){
      .graph-row { grid-template-columns: 1fr; }
    }

    /* Scenario Planner */
    #scenario-planner.fade-in { animation: fadeIn 0.4s ease-out forwards; }
    @keyframes fadeIn { from { opacity:0; transform:translateY(10px);} to {opacity:1; transform:translateY(0);} }

    /* Two equal charts in Scenario Planner */
    #scenarioGrid { display:grid; grid-template-columns: 1fr 1fr; gap:20px; }
    @media (max-width: 900px){
      #scenarioGrid { grid-template-columns: 1fr; }
    }

    /* Suffix inside input boxes (%/yr) */
    .with-suffix { position: relative; }
    .with-suffix input {
      padding-right: 70px; /* space for the suffix */
    }
    .with-suffix::after {
      content: attr(data-suffix);
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 14px;
      color: #4a5568;
      pointer-events: none;
    }
  </style>

  <script src="https://code.highcharts.com/highcharts.js"></script>
</head>
<body>

<!-- HEADER -->
<header class="site-header">
  <div class="cb-wrap header-inner">
    <a class="brand" href="beta.html">FinTech Tools</a>
    <button class="nav-toggle" aria-expanded="false">☰</button>
    <nav id="primary-nav" class="nav-links">
      <a href="#retirement">Retirement Planner</a>
      <a href="budget.html">Budget Tool</a>
    </nav>
  </div>
</header>

<!-- MAIN -->
<div class="cb-wrap">

  <div class="cb-header" id="retirement">
    <h1 class="cb-title">Retirement Calculator</h1>
    <div class="cb-sub">Use the best retirement calculator on the web to understand your financial future.</div>
  </div>

  <div class="cb-stack">

    <!-- Section 1: Inputs (visible on load) -->
    <div class="cb-card">
      <div class="cb-row">
        <div class="cb-field"><label>Date of Birth</label><input id="dob" type="date" /></div>
        <div class="cb-field"><label>Retirement Date</label><input id="retireDate" type="date" /></div>
        <div class="cb-field"><label>Current Savings ($)</label><input id="retiresavings" type="number" /></div>

        <div class="cb-field"><label>Annual Contributions ($)</label><input id="futureretiresavings" type="number" /></div>
        <div class="cb-field"><label>Social Security Start</label><input id="socsecAge" type="date" /></div>

        <div class="cb-field">
          <label class="tooltip-click-container">
            Estimated Annual Social Security ($)
            <span class="click-icon" id="ssInfoBtn">?</span>
            <div class="tooltip-click-box" id="ssInfoBox">
              Unsure how much you'll get? Use these official tools:<br><br>
              • View your personalized estimate:<br>
              <a href="https://www.ssa.gov/myaccount" target="_blank">SSA MyAccount</a><br><br>
              • Quick benefit estimate calculator:<br>
              <a href="https://www.ssa.gov/OACT/quickcalc/" target="_blank">SSA Quick Calculator</a>
            </div>
          </label>
          <input id="socsecAmt" type="number" />
        </div>

        <div class="cb-field"><label>Pension Start</label><input id="pensiondate" type="date" /></div>
        <div class="cb-field"><label>Pension Amount ($)</label><input id="pensions" type="number" /></div>

        <!-- Non-retirement assets -->
        <div class="cb-field">
          <label class="tooltip-click-container">
            Non-Retirement Assets ($)
            <span class="click-icon" id="taxableInfoBtn">i</span>
            <div class="tooltip-click-box" id="taxableInfoBox">
              Taxable savings/stocks/cash not in retirement accounts. We assume a small annual “tax drag”
              on growth (default 0.6%) in the main projection. You can fine-tune this in Scenario Planner.
            </div>
          </label>
          <input id="taxableNow" type="number" />
        </div>
      </div>

      <div class="cb-actions"><button id="runCalc">Run Calculation</button></div>
    </div>

    <!-- Section 2A: Toggles (hidden) -->
    <div id="postCalcOptions" class="cb-card">
      <div class="toggle-row">
        <div class="toggle-item">
          <label class="tooltip-click-container">
            Account for inflation?
            <span class="click-icon" id="inflationQM">?</span>
            <div class="tooltip-click-box" id="inflationBox">
              Adjusts all future dollars back into today’s dollars using 3% inflation.
            </div>
          </label>
          <label class="switch">
            <input type="checkbox" id="inflationToggle"><span class="slider"></span>
          </label>
        </div>

        <div class="toggle-item">
          <label class="tooltip-click-container">
            Model withdrawals?
            <span class="click-icon" id="withdrawQM">?</span>
            <div class="tooltip-click-box" id="withdrawBox">
              Standard 4% annual distribution starting at retirement.
            </div>
          </label>
          <label class="switch">
            <input type="checkbox" id="withdrawToggle"><span class="slider"></span>
          </label>
        </div>
      </div>
    </div>

    <!-- Section 2B: Chart card (hidden) -->
    <div id="chartSection" class="cb-card" style="display:none;">
      <h2 id="chartTitle" style="margin:0; font-size:22px; font-weight:700;">
        Projected Retirement Savings
      </h2>
      <div id="chartSubtitle" style="margin-bottom:14px; font-size:14px; color:#4a5568;"></div>

      <div class="graph-row">
        <div id="chart" style="height:360px;"></div>
        <aside id="scenarioPrompt" aria-live="polite"></aside>
      </div>
    </div>

    <!-- Section 3: Scenario Planner (hidden) -->
    <section id="scenario-planner" class="cb-card" style="scroll-margin-top:80px; display:none;">
      <h2 style="margin:0 0 8px 0;">Scenario Planner</h2>
      <div class="cb-sub" style="margin:0 0 16px 0;">
        Set your assumptions and monthly need, then review the breakdown and long-term projection.
      </div>

      <!-- Scenario Planner — Assumptions + Monthly Need (no tooltips for these dials) -->
      <div class="cb-card" id="scenario-inputs" style="margin-bottom:16px;">
        <h3 style="margin:0 0 8px 0; font-size:18px;">Assumptions</h3>
        <div class="cb-row" style="grid-template-columns: repeat(4, 1fr);">
          <div class="cb-field with-suffix" data-suffix="%/yr">
            <label>Expected Return</label>
            <input id="spReturnPct" type="number" step="0.1" min="0" max="100" value="6" />
          </div>

          <div class="cb-field with-suffix" data-suffix="%/yr">
            <label>Inflation Rate</label>
            <input id="spInflationPct" type="number" step="0.1" min="0" max="100" value="3" />
          </div>

          <div class="cb-field with-suffix" data-suffix="%/yr">
            <label>Withdrawal Rate</label>
            <input id="spWithdrawPct" type="number" step="0.1" min="1" max="100" value="4" />
          </div>

          <div class="cb-field with-suffix" data-suffix="%/yr">
            <label>Tax Drag on Non-Retirement Assets</label>
            <input id="spTaxDragPct" type="number" step="0.1" min="0" max="2" value="0.6" />
            <small style="color:#4a5568;">Reduces taxable-account growth to approximate ongoing taxes.</small>
          </div>
        </div>

        <hr style="border:none; border-top:1px solid #e5e9f2; margin:16px 0;">

        <h3 style="margin:0 0 8px 0; font-size:18px;">Monthly Need</h3>
        <div class="cb-row" style="grid-template-columns: 1fr;">
          <div class="cb-field">
            <label>Monthly spending needed in retirement (today’s dollars)</label>
            <input id="spMonthlyNeed" type="number" placeholder="e.g., 4500" />
            <small style="color:#4a5568;">Most people need <strong>70–90%</strong> of their current monthly spending.</small>
          </div>
        </div>
      </div>
      <!-- End Inputs -->

      <!-- Two equal charts side-by-side -->
      <div id="scenarioGrid">
        <div>
          <h3 style="margin:0 0 8px 0; font-size:16px;">Monthly Resources @ Retirement (Stacked)</h3>
          <div id="breakdownChart" style="height:320px;"></div>
        </div>
        <div>
          <h3 style="margin:0 0 8px 0; font-size:16px;">Portfolio Projection (Nominal)</h3>
          <div id="scenarioChart" style="height:320px;"></div>
        </div>
      </div>
    </section>

  </div>
</div>

<!-- Tooltips (top section only) -->
<script>
function setupTooltip(btnId, boxId) {
  const btn = document.getElementById(btnId);
  const box = document.getElementById(boxId);
  if (!btn || !box) return;

  btn.addEventListener("click", e => {
    e.stopPropagation();
    box.style.display = (box.style.display === "block" ? "none" : "block");
  });

  document.addEventListener("click", () => { box.style.display = "none"; });
}

document.addEventListener("DOMContentLoaded", () => {
  setupTooltip("ssInfoBtn", "ssInfoBox");
  setupTooltip("inflationQM", "inflationBox");
  setupTooltip("withdrawQM", "withdrawBox");
  setupTooltip("taxableInfoBtn", "taxableInfoBox");
});
</script>

<!-- Mobile nav -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  const btn = document.querySelector(".nav-toggle");
  const nav = document.getElementById("primary-nav");
  if (!btn || !nav) return;

  btn.addEventListener("click", () => {
    const opened = nav.classList.toggle("open");
    btn.setAttribute("aria-expanded", opened ? "true" : "false");
  });
});
</script>

<!-- Calculator + Highcharts (Main chart) -->
<script>
let hcChart = null;

// Include taxable assets in baseline with default tax drag
const TAX_DRAG_DEFAULT = 0.006; // 0.6%/yr drag on taxable growth in the MAIN chart only

/* Right-side scenario prompt */
function showScenarioPrompt() {
  const box = document.getElementById("scenarioPrompt");
  if (!box || box.dataset.active === "1") return;

  box.innerHTML = `
    <p><strong>Want to see if this is enough to retire?</strong><br>
    Let’s use the scenario planner to find out.</p>
    <button id="scenarioBtn" class="btn-primary">Scenario Planner</button>
  `;
  box.style.display = "block";
  box.dataset.active = "1";

  const btn = document.getElementById("scenarioBtn");
  btn.addEventListener("click", () => {
    const target = document.getElementById("scenario-planner");
    if (!target) return;

    target.style.display = "block";
    target.classList.add("fade-in");
    target.scrollIntoView({ behavior: "smooth", block: "start" });

    buildScenarioCharts(); // render when opened
  });
}

/* Helpers */
function parseDate(s){ const [y,m,d] = s.split("-").map(Number); return new Date(y,(m||1)-1,d||1); }
function yearsBetween(a, b){ return (b - a) / (365.25 * 86400000); }
function yearsFromToday(targetYear){
  const now = new Date();
  const then = new Date(targetYear, now.getMonth(), now.getDate());
  return (then - now) / (365.25*86400000);
}

/* Scenario Planner input state (no sliders) */
window.spInputs = {
  returnPct: 6,
  inflationPct: 3,
  withdrawPct: 4,
  taxDragPct: 0.6,
  monthlyNeed: 0
};

function bindNumber(id, key, min, max){
  const el = document.getElementById(id);
  if (!el) return;
  const clamp = v => Math.min(max, Math.max(min, Number(v)));
  function update(){
    const v = clamp(el.value || 0);
    el.value = v;
    window.spInputs[key] = v;
    broadcastSP();
  }
  el.addEventListener('input', update);
  el.addEventListener('change', update);
}
function broadcastSP(){
  document.dispatchEvent(new CustomEvent('scenario-inputs:change', { detail: { ...window.spInputs }}));
}

document.addEventListener('DOMContentLoaded', () => {
  // Bind numeric fields
  bindNumber('spReturnPct','returnPct',0,100);
  bindNumber('spInflationPct','inflationPct',0,100);
  bindNumber('spWithdrawPct','withdrawPct',1,100);
  bindNumber('spTaxDragPct','taxDragPct',0,2);
  bindNumber('spMonthlyNeed','monthlyNeed',0,1000000);

  // Initialize values
  document.getElementById('spReturnPct').value = window.spInputs.returnPct;
  document.getElementById('spInflationPct').value = window.spInputs.inflationPct;
  document.getElementById('spWithdrawPct').value = window.spInputs.withdrawPct;
  document.getElementById('spTaxDragPct').value = window.spInputs.taxDragPct;

  // Fire initial for charts listening
  broadcastSP();
});

document.getElementById("runCalc").addEventListener("click", function () {
  // Reveal Section 2 (toggles + chart card)
  document.getElementById("postCalcOptions").style.display = "block";
  document.getElementById("chartSection").style.display = "block";

  /* Subtitle (also disclose default tax drag for taxable assets) */
  function updateChartSubtitle() {
    const inf = document.getElementById('inflationToggle').checked;
    const wd  = document.getElementById('withdrawToggle').checked;

    const infText = inf
      ? "Projections include inflation adjustment (3%)."
      : "Projections do not account for inflation.";

    const wdText = wd
      ? "Projections include a 4% distribution."
      : "Projections do not include distributions.";

    const taxDragDisclosure = "Includes non-retirement assets with 0.6%/yr tax drag.";
    document.getElementById("chartSubtitle").textContent = `${infText} ${wdText} ${taxDragDisclosure}`;
  }
  updateChartSubtitle();

  /* Inputs */
  const dobStr = document.getElementById("dob").value;
  const retireStr = document.getElementById("retireDate").value;
  if (!dobStr || !retireStr) return alert("Enter DOB and Retirement Date.");

  const dob = parseDate(dobStr);
  const retireDate = parseDate(retireStr);
  const retireYear = retireDate.getFullYear();

  const ssStr = document.getElementById("socsecAge").value;
  const ssAmt = Number(document.getElementById("socsecAmt").value || 0);
  const penStr = document.getElementById("pensiondate").value;
  const penAmt = Number(document.getElementById("pensions").value || 0);

  const ssStart = ssStr ? parseDate(ssStr) : null;
  const penStart = penStr ? parseDate(penStr) : null;

  const retireNow = Number(document.getElementById("retiresavings").value || 0);
  const retireAnnual = Number(document.getElementById("futureretiresavings").value || 0);

  // Taxable bucket (only initial amount in baseline)
  const taxableNow = Number(document.getElementById("taxableNow").value || 0);

  const inflationActive = document.getElementById('inflationToggle').checked;
  const withdrawActive  = document.getElementById('withdrawToggle').checked;

  const INFL = 0.03;
  const WD   = 0.04;

  /* Timeline */
  const today = new Date();
  const currentYear = today.getFullYear() + 1; // avoid “free” growth this year
  const endYear = dob.getFullYear() + 100;
  const timeline = [];
  for (let y = currentYear; y <= endYear; y++) timeline.push(y);

  /* Inflows */
  const flowContribRet = timeline.map(y => (y < retireYear ? retireAnnual : 0));
  const flowSS = timeline.map(y => (ssStart && y >= ssStart.getFullYear() ? ssAmt : 0));
  const flowPension = timeline.map(y =>
    (penStart && y >= penStart.getFullYear() && y <= dob.getFullYear()+92) ? penAmt : 0
  );

  /* Deflator for main chart only (if chosen) */
  function deflate(value, idx){
    if (!inflationActive) return value;
    return value / Math.pow(1 + INFL, yearsFromToday(timeline[idx]));
  }

  /* Dual-bucket simulation for a given return rate:
     - Retirement bucket grows at full 'rate'
     - Taxable bucket grows at (rate - TAX_DRAG_DEFAULT)
     - Proportional withdrawals after retirement (if enabled)
  */
  function simulateDual(rate){
    let balRet = retireNow;
    let balTax = taxableNow;
    const totalBal = [];

    for (let i=0; i<timeline.length; i++){
      const rRet = rate;
      const rTax = Math.max(0, rate - TAX_DRAG_DEFAULT);

      // Grow
      balRet *= (1 + rRet);
      balTax *= (1 + rTax);

      // Contributions to retirement bucket only
      balRet += flowContribRet[i];

      // Withdrawals (if enabled) after retirement
      if (withdrawActive && timeline[i] >= retireYear){
        const combined = balRet + balTax;
        const wdAmt = combined * WD;
        const retShare = combined > 0 ? (balRet / combined) : 0.5;
        const taxShare = 1 - retShare;
        balRet -= wdAmt * retShare;
        balTax -= wdAmt * taxShare;
      }

      const sum = balRet + balTax + flowSS[i] + flowPension[i]; // include contemporaneous income
      totalBal.push(deflate(sum, i));
    }
    return totalBal;
  }

  const p3 = simulateDual(0.03);
  const p5 = simulateDual(0.05);
  const p7 = simulateDual(0.07);
  const p9 = simulateDual(0.09);

  function filter(path){
    const startYear = retireYear - 10;
    return timeline
      .map((y,i) => y >= startYear ? [Date.UTC(y,0,1), path[i]] : null)
      .filter(Boolean);
  }

  if (hcChart) hcChart.destroy();

  hcChart = Highcharts.chart("chart", {
    chart: { zooming:{type:"x"}, backgroundColor:"#fff", height:360 },
    title: { text:null },
    xAxis: { type:"datetime" },
    yAxis: {
      title:{ text:"Balance / Income ($)" },
      labels:{ formatter(){ return "$" + Highcharts.numberFormat(this.value,0) } }
    },
    legend:{ enabled:true, align:"center", verticalAlign:"top" },
    tooltip:{
      shared:true,
      formatter: function () {
        const x = (this.points && this.points[0]) ? this.points[0].x : this.x;
        const year = Highcharts.dateFormat('%Y', x);
        const lines = (this.points || [this.point]).map(p =>
          `<span style="color:${p.color}">●</span> ${p.series.name}: <b>$${Highcharts.numberFormat(p.y, 0)}</b>`
        ).join('<br/>');
        return `<b>${year}</b><br/>${lines}`;
      }
    },
    credits:{ enabled:false },
    series:[
      { name:"3%", data:filter(p3), type:"line", lineWidth:2 },
      { name:"5%", data:filter(p5), type:"line", lineWidth:2 },
      { name:"7%", data:filter(p7), type:"line", lineWidth:2 },
      { name:"9%", data:filter(p9), type:"line", lineWidth:2 }
    ]
  });

  // Reveal the right-side prompt after main chart renders
  showScenarioPrompt();
});

/* Auto-update main chart when toggles change */
(function(){
  function rerun() {
    const btn = document.getElementById("runCalc");
    if (btn) btn.click();
  }
  document.addEventListener("change", e => {
    if (["inflationToggle","withdrawToggle"].includes(e.target.id)) rerun();
  });
  document
    .querySelectorAll("#postCalcOptions .switch, #postCalcOptions .slider")
    .forEach(el => el.addEventListener("click", rerun));
})();
</script>

<!-- Scenario Planner charts (Nominal) -->
<script>
function buildScenarioCharts() {
  // Core inputs
  const dobStr = document.getElementById("dob").value;
  const retireStr = document.getElementById("retireDate").value;
  if (!dobStr || !retireStr) return;

  const dob = parseDate(dobStr);
  const retireDate = parseDate(retireStr);
  const retireYear = retireDate.getFullYear();

  const ssStr = document.getElementById("socsecAge").value;
  const ssAmtAnnual = Number(document.getElementById("socsecAmt").value || 0); // nominal (fixed)
  const penStr = document.getElementById("pensiondate").value;
  const penAmtAnnual = Number(document.getElementById("pensions").value || 0); // nominal (fixed)

  const ssStart = ssStr ? parseDate(ssStr) : null;
  const penStart = penStr ? parseDate(penStr) : null;

  const retireNow = Number(document.getElementById("retiresavings").value || 0);
  const retireAnnual = Number(document.getElementById("futureretiresavings").value || 0);
  const taxableNow = Number(document.getElementById("taxableNow").value || 0);

  // Scenario Planner dials
  const rNom   = Number(window.spInputs.returnPct || 6) / 100;       // expected return
  const infl   = Number(window.spInputs.inflationPct || 3) / 100;    // used to inflate need
  const wdRate = Number(window.spInputs.withdrawPct || 4) / 100;     // withdrawal rate
  const drag   = Math.max(0, Number(window.spInputs.taxDragPct || 0.6)) / 100; // tax drag on taxable

  const monthlyNeedToday = Number(window.spInputs.monthlyNeed || 0);

  // Timeline
  const today = new Date();
  const currentYear = today.getFullYear() + 1;
  const endYear = dob.getFullYear() + 100;
  const timeline = [];
  for (let y=currentYear; y<=endYear; y++) timeline.push(y);

  // Years to retirement (fractional) for inflating the monthly need
  const yrsToRet = Math.max(0, yearsBetween(today, retireDate));
  const monthlyNeedAtRet = monthlyNeedToday * Math.pow(1 + infl, yrsToRet);

  // --- Compute balances at retirement (nominal) ---
  function growToRetirement() {
    let balRet = retireNow;
    let balTax = taxableNow;

    // Walk year by year until retirement year
    const startY = currentYear;
    for (let y = startY; y <= retireYear; y++) {
      // Growth during year
      balRet *= (1 + rNom);
      balTax *= (1 + Math.max(0, rNom - drag));

      // Contribution at year-end to retirement bucket (only before retirement year)
      if (y < retireYear) balRet += retireAnnual;
    }
    return { balRet, balTax };
  }

  const { balRet, balTax } = growToRetirement();

  // Monthly inflows at retirement year (SS/Pension fixed nominal if started)
  const ssMonthly = (ssStart && ssStart.getFullYear() <= retireYear) ? (ssAmtAnnual / 12) : 0;
  const penMonthly = (penStart && penStart.getFullYear() <= retireYear) ? (penAmtAnnual / 12) : 0;
  const retWdMonthly = (wdRate * balRet) / 12;
  const taxWdMonthly = (wdRate * balTax) / 12;

  const stackTotalMonthly = ssMonthly + penMonthly + retWdMonthly + taxWdMonthly;
  const gap = monthlyNeedAtRet - stackTotalMonthly;
  const gapText = gap > 0
    ? `Gap: $${Highcharts.numberFormat(gap, 0)}/mo`
    : `Surplus: $${Highcharts.numberFormat(-gap, 0)}/mo`;

  // --- Build stacked single-bar chart ---
  Highcharts.chart('breakdownChart', {
    chart: { type: 'column', backgroundColor: '#fff', height: 320 },
    title: { text: null },
    xAxis: { categories: ['Retirement Year'] },
    yAxis: {
      min: 0,
      title: { text: 'Monthly Resources ($)' },
      plotLines: [{
        value: monthlyNeedAtRet,
        color: '#000',
        width: 3,
        zIndex: 5,
        label: {
          text: `Need: $${Highcharts.numberFormat(monthlyNeedAtRet,0)}/mo`,
          align: 'right',
          x: -10,
          y: -6,
          style: { color: '#000', fontWeight: '700' }
        }
      }]
    },
    legend: { align:'center', verticalAlign:'top' },
    tooltip: {
      shared: true,
      formatter: function(){
        const total = this.points.reduce((s,p)=>s+p.y,0);
        const lines = this.points.map(p =>
          `<span style="color:${p.color}">●</span> ${p.series.name}: <b>$${Highcharts.numberFormat(p.y,0)}/mo</b>`
        ).join('<br/>');
        return `<b>${this.x}</b><br/>${lines}<br/><b>Total: $${Highcharts.numberFormat(total,0)}/mo</b>`;
      }
    },
    plotOptions: { column: { stacking: 'normal', dataLabels: { enabled: true, formatter(){ return '$' + Highcharts.numberFormat(this.y,0); } } } },
    credits: { enabled:false },
    series: [
      { name:'Social Security', data: [ssMonthly] },
      { name:'Pensions / DB', data: [penMonthly] },
      { name:'Retirement Acct Withdrawal', data: [retWdMonthly] },
      { name:'Non-Retirement Withdrawal', data: [taxWdMonthly] }
    ],
    subtitle: { text: gapText, style: { fontWeight:'700', color: gap > 0 ? '#b91c1c' : '#166534' } }
  });

  // --- Build nominal portfolio line over time ---
  function simulateLine() {
    let r = retireNow;
    let t = taxableNow;
    const points = [];

    for (let i=0; i<timeline.length; i++) {
      const y = timeline[i];

      // Growth
      r *= (1 + rNom);
      t *= (1 + Math.max(0, rNom - drag));

      // Contributions before retirement
      if (y < retireYear) r += retireAnnual;

      // Withdraw after retirement
      if (y >= retireYear) {
        const total = r + t;
        const wd = total * wdRate;
        const shareR = total > 0 ? (r / total) : 0.5;
        const shareT = 1 - shareR;
        r -= wd * shareR;
        t -= wd * shareT;
      }

      points.push([Date.UTC(y,0,1), Math.max(0, r + t)]);
    }
    return points;
  }

  Highcharts.chart('scenarioChart', {
    chart: { backgroundColor: '#fff', height: 320 },
    title: { text: null },
    xAxis: { type: 'datetime' },
    yAxis: {
      title: { text: 'Portfolio Balance ($)' },
      labels: { formatter(){ return "$" + Highcharts.numberFormat(this.value, 0); } }
    },
    legend: { enabled:false },
    tooltip: {
      pointFormat: '<b>${point.y:,.0f}</b>',
      xDateFormat: '%Y'
    },
    credits: { enabled:false },
    series: [
      { name:`Nominal Balance`, type:'line', lineWidth:2, data: simulateLine() }
    ]
  });
}

// Rebuild Scenario charts when inputs change (and section is visible)
document.addEventListener('scenario-inputs:change', () => {
  const sp = document.getElementById('scenario-planner');
  if (sp && sp.style.display !== 'none') buildScenarioCharts();
});
document.addEventListener('change', (e) => {
  const sp = document.getElementById('scenario-planner');
  if (!sp || sp.style.display === 'none') return;

  const ids = new Set([
    'dob','retireDate','socsecAge','socsecAmt','pensiondate','pensions',
    'retiresavings','futureretiresavings','taxableNow'
  ]);
  if (ids.has(e.target.id)) {
    buildScenarioCharts();
  }
});
</script>

</body>
</html>
