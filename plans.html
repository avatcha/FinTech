<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Healthcare Plan Finder (Mock)</title>

  <!-- Font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#f7f9fc; --text:#0a0f2c; --muted:#4a5568; --brand:#1a73e8; --brand-700:#0f5ad2;
      --card:#fff; --stroke:#e5e9f2; --soft:#f7f9ff; --shadow:0 10px 30px rgba(2,6,23,0.07);
      --radius:18px; --pad-x:28px; --content-w:1200px;
    }
    @media (prefers-color-scheme: dark){
      :root{ --bg:#0b1220; --text:#e7ecf6; --muted:#a5b1cc; --card:#0e172a; --stroke:#1e293b; --soft:#0f1b33; --shadow:none; }
    }
    body { font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,sans-serif; background:var(--bg); margin:0; padding-top:64px; color:var(--text); }

    .cb-wrap { max-width: var(--content-w); margin: 0 auto; padding: 0 var(--pad-x); }
    .site-header { position: sticky; top: 0; z-index: 1000; background: rgba(255,255,255,.85); backdrop-filter: blur(8px); border-bottom: 1px solid var(--stroke); }
    @media (prefers-color-scheme: dark){ .site-header{ background: rgba(10,15,28,.65); } }
    .header-inner { display:flex; justify-content:space-between; align-items:center; min-height:60px; }
    .brand { font-weight:800; font-size:20px; text-decoration:none; color:var(--text); }
    .nav-links { display:flex; gap:20px; }
    .nav-links a { color:inherit; font-weight:600; text-decoration:none; font-size:14px; }
    .nav-links a:hover { text-decoration: underline; }

    .cb-header { margin: 20px 0; }
    .cb-title { font-size: clamp(24px, 3.6vw, 40px); font-weight: 700; margin: 0; }
    .cb-sub { font-size: 15px; color: var(--muted); margin-top: 6px; }

    .cb-card { background: var(--card); padding: 20px; border-radius: var(--radius); box-shadow: var(--shadow); border: 1px solid var(--stroke); margin-bottom:20px; }
    .cb-stack { display:flex; flex-direction:column; gap:16px; }
    .cb-row { display:grid; grid-template-columns: repeat(2, 1fr); gap:16px; }
    @media (max-width: 740px){ .cb-row { grid-template-columns: 1fr; } }

    label { font-size:14px; font-weight:600; display:block; }
    input, select, button {
      font-size:16px; padding:12px 14px; border-radius:14px; border:1px solid var(--stroke); background:#fff; width:100%;
    }
    button { background:var(--brand); color:#fff; font-weight:700; cursor:pointer; }
    button:hover { background:var(--brand-700); }
    .btn-secondary { background:#eef2ff; color:#1f2a59; border:1px solid var(--stroke); }

    .drug-chip { display:flex; gap:10px; align-items:center; background:var(--soft); border:1px solid var(--stroke); padding:8px 12px; border-radius:999px; margin-top:8px; }
    .small { font-size:12px; color:var(--muted); }
    details > summary { cursor:pointer; font-weight:700; }
    table { width:100%; border-collapse: collapse; margin-top:8px; }
    th, td { padding:8px; border-bottom:1px solid var(--stroke); text-align:left; }
    th { font-size:12px; color:var(--muted); }
  </style>
</head>

<body>

<header class="site-header">
  <div class="cb-wrap header-inner">
    <a class="brand" href="index.html">stakxAi</a>

    <nav id="primary-nav" class="nav-links">
      <a href="index.html#retirement">Retirement Planner</a>
      <a href="budget/easy.html">Budget Tool</a>
      <a href="plans.html">Healthcare</a>
    </nav>
  </div>
</header>

<main class="cb-wrap">
  <div class="cb-header">
    <h1 class="cb-title">Healthcare Plan Finder (Mock)</h1>
    <div class="cb-sub">This is a simplified prototype. Replace mock data later.</div>
  </div>

  <!-- USER INPUTS -->
  <div class="cb-card">
    <div class="cb-row">
      <div>
        <label>Coverage</label>
        <select id="universe">
          <option value="ACA">ACA / Exchange</option>
          <option value="Medicare">Medicare</option>
          <option value="OffExchange">Off Exchange</option>
        </select>
      </div>

      <div>
        <label>ZIP</label>
        <input id="zip" placeholder="12345" />
      </div>

      <div>
        <label>Pharmacy</label>
        <select id="pharmacy">
          <option value="preferred">Preferred retail</option>
          <option value="standard">Standard retail</option>
          <option value="mail">Mail order</option>
        </select>
      </div>

      <div>
        <label>Medications</label>
        <div style="display:flex; gap:8px;">
          <input id="drugInput" placeholder="atorvastatin" />
          <button id="addDrugBtn" style="width:auto;">Add</button>
        </div>
        <div id="drugList"></div>
      </div>
    </div>

    <div style="display:flex; gap:10px; margin-top:14px; flex-wrap:wrap;">
      <button id="runBtn">Get suggestions</button>
      <button id="clearBtn" class="btn-secondary">Clear</button>
      <span class="small">Mock data — not real pricing.</span>
    </div>
  </div>

  <!-- RESULTS -->
  <div id="resultsCard" class="cb-card" style="display:none;">
    <h2>Plan suggestions</h2>
    <div id="results"></div>
    <p class="small">This tool is a prototype. Replace with real QHP / Medicare data.</p>
  </div>
</main>


<script>
/* ---------------- MOCK DATA ---------------- */
const MOCK_RXNORM = {
  atorvastatin: { rxcui: "83367", strength: "20 mg" },
  metformin:    { rxcui: "860975", strength: "500 mg" },
  ozempic:      { rxcui: "1991311", strength: "2 mg/1.5 mL" },
};

const MOCK_PLANS = [
  {
    id: "aca-1",
    issuer: "Acme Health",
    name: "Acme Silver 2000",
    coverageUniverse: "ACA",
    metal: "Silver",
    premiumMonthly: 485,
    deductibleDrug: 0,
    pharmacyNetwork: ["preferred","standard","mail"],
    tiers: [
      { tier: 1, copayPreferred: 5,  copayStandard: 12, copayMail: 12 },
      { tier: 2, copayPreferred: 25, copayStandard: 40, copayMail: 35 },
      { tier: 3, coinsurance: 0.35 },
    ],
    notes: ["Good Tier 1/2 copays"],
  },

  {
    id: "medd-1",
    issuer: "Sunrise Rx",
    name: "Sunrise Part D Value",
    coverageUniverse: "Medicare",
    premiumMonthly: 25,
    deductibleDrug: 545,
    pharmacyNetwork: ["preferred","standard","mail"],
    tiers: [
      { tier: 1, copayPreferred: 0, copayStandard: 5, copayMail: 0 },
      { tier: 2, copayPreferred: 8, copayStandard: 15, copayMail: 8 },
      { tier: 3, coinsurance: 0.25 },
    ],
  }
];

const MOCK_FORMULARIES = {
  "aca-1": [
    { rxcui: "83367", tier: 1, estNegotiatedPrice30: 8 },
    { rxcui: "860975", tier: 1, estNegotiatedPrice30: 6 },
  ],
  "medd-1": [
    { rxcui: "83367", tier: 1, estNegotiatedPrice30: 5 },
    { rxcui: "860975", tier: 1, estNegotiatedPrice30: 5 },
  ]
};

/* ---------------- UTILS ---------------- */
const delay = ms => new Promise(res => setTimeout(res, ms));

const api = {
  normalizeDrug: async txt => {
    await delay(80);
    let key = txt.trim().toLowerCase();
    return MOCK_RXNORM[key] ?
      { rxcui: MOCK_RXNORM[key].rxcui, name: txt, strength: MOCK_RXNORM[key].strength } :
      { rxcui: "rx-" + key, name: txt };
  },
  listPlans: async universe => {
    await delay(100);
    return MOCK_PLANS.filter(p => p.coverageUniverse === universe);
  },
};

function estimateAnnual(plan, drugs, pharmacy) {
  let annualDrugs = 0;
  const breakdown =[];

  const formulary = MOCK_FORMULARIES[plan.id] || [];

  drugs.forEach(d=>{
    const fd = formulary.find(f => f.rxcui === d.rxcui);
    if (!fd) {
      breakdown.push({ drug:d.name, tier:"-", fill:0, annual:0, note:"Not covered" });
      return;
    }

    const tier = plan.tiers.find(t=>t.tier===fd.tier);
    let cost = 0;

    if (tier.coinsurance) {
      cost = fd.estNegotiatedPrice30 * tier.coinsurance;
    } else {
      cost = tier.copayPreferred ?? 0;
    }

    const annual = cost * 12;
    annualDrugs += annual;

    breakdown.push({
      drug: d.name,
      tier: fd.tier,
      fill: cost.toFixed(2),
      annual: annual.toFixed(0),
      note: ""
    });
  });

  const annualPremium = plan.premiumMonthly * 12;
  const total = annualPremium + annualDrugs;

  return { plan, annualDrugs, annualPremium, total, breakdown };
}

/* ---------------- UI LOGIC ---------------- */
let drugs = [];

const drugInput = document.getElementById("drugInput");
const drugList  = document.getElementById("drugList");

document.getElementById("addDrugBtn").onclick = async () => {
  if (!drugInput.value.trim()) return;

  const norm = await api.normalizeDrug(drugInput.value.trim());
  drugs.push({ name: norm.name, rxcui: norm.rxcui, monthlyQty:1 });

  renderDrugs();
  drugInput.value = "";
};

function renderDrugs() {
  drugList.innerHTML = "";
  drugs.forEach((d,i)=>{
    let el = document.createElement("div");
    el.className="drug-chip";
    el.innerHTML = `
      <span>${d.name}</span>
      <button class="btn-secondary" style="width:auto;">Remove</button>
    `;
    el.querySelector("button").onclick = () => {
      drugs = drugs.filter((_,idx)=>idx!==i);
      renderDrugs();
    };
    drugList.appendChild(el);
  });
}

document.getElementById("clearBtn").onclick = ()=>{
  drugs=[];
  renderDrugs();
  document.getElementById("resultsCard").style.display="none";
};

document.getElementById("runBtn").onclick = async () => {
  const universe = document.getElementById("universe").value;
  const pharmacy = document.getElementById("pharmacy").value;

  const plans = await api.listPlans(universe);

  const scored = plans.map(p => estimateAnnual(p, drugs, pharmacy));
  scored.sort((a,b)=>a.total - b.total);

  renderResults(scored);
};

function renderResults(scored){
  const out = document.getElementById("results");
  const card = document.getElementById("resultsCard");

  out.innerHTML = "";
  card.style.display="block";

  scored.forEach(r=>{
    let div=document.createElement("div");
    div.className="cb-card";
    div.innerHTML = `
      <h3>${r.plan.issuer} — ${r.plan.name}</h3>
      <p class="small">Premium: $${(r.annualPremium/12).toFixed(0)}/mo</p>
      <p><strong>Total Estimated Annual Cost: $${r.total.toFixed(0)}</strong></p>

      <details>
        <summary>Explain the math</summary>
        <table>
          <thead>
            <tr><th>Drug</th><th>Tier</th><th>Per Fill</th><th>Annual</th><th>Notes</th></tr>
          </thead>
          <tbody>
            ${r.breakdown
              .map(b=>`
                <tr>
                  <td>${b.drug}</td>
                  <td>${b.tier}</td>
                  <td>$${b.fill}</td>
                  <td>$${b.annual}</td>
                  <td>${b.note}</td>
                </tr>
              `).join("")}
          </tbody>
        </table>
      </details>
    `;
    out.appendChild(div);
  });
}
</script>

</body>
</html>
